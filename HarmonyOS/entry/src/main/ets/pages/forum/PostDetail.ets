import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { getPostDetail, likePost, commentPost, PostDetailData, Comment, updatePostStatus } from '../../model/api/ForumApi';
import { getUserProfile } from '../../model/api/UserApi';
import RouterManager from '../../router/RouterManager';

interface UserProfileParams {
  userId: string;
  username?: string;
  avatar?: string;
}

interface PostCommentParams {
  comments: Comment[];
}

// èœå•é¡¹ç±»å‹ï¼ŒåŒ¹é… bindMenu æ‰€éœ€çš„ç»“æ„
interface MenuElementItem {
  value: string;
  action: () => void;
}

@Entry
@Component
struct PostDetail {
  @State postId: string = '';
  @State post: PostDetailData | null = null;
  @State isLoading: boolean = false;
  @State commentContent: string = '';
  @State isLiking: boolean = false;
  @State isCommenting: boolean = false;
  @State currentUserId: string = '';

  aboutToAppear() {
    const params = router.getParams() as Record<string, Object>;
    if (params && params['postId']) {
      this.postId = params['postId'] as string;
      this.loadPostDetail();
      this.loadCurrentUser();
    } else {
      promptAction.showToast({ message: 'å‚æ•°é”™è¯¯' });
      RouterManager.goBack();
    }
  }

  async loadCurrentUser() {
    try {
      const resp = await getUserProfile();
      if (resp.code === 200 && resp.data) {
        this.currentUserId = resp.data.userId;
      }
    } catch (e) {
      console.error('Load user profile failed', e);
    }
  }

  async loadPostDetail() {
    this.isLoading = true;
    try {
      const response = await getPostDetail(this.postId);
      if (response.code === 200) {
        this.post = response.data;
      } else {
        promptAction.showToast({ message: response.message || 'åŠ è½½å¤±è´¥' });
      }
    } catch (error) {
      console.error('Load post detail failed:', error);
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯' });
    } finally {
      this.isLoading = false;
    }
  }

  async handleLike() {
    if (this.isLiking || !this.post) return;
    this.isLiking = true;
    try {
      const response = await likePost(this.postId);
      if (response.code === 200) {
        this.post.likeCount += 1; // ç®€å•æ¨¡æ‹Ÿç‚¹èµæ•°å¢åŠ 
        promptAction.showToast({ message: 'ç‚¹èµæˆåŠŸ' });
      }
    } catch (error) {
      promptAction.showToast({ message: 'æ“ä½œå¤±è´¥' });
    } finally {
      this.isLiking = false;
    }
  }

  async handleComment() {
    if (!this.commentContent.trim()) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥è¯„è®ºå†…å®¹' });
      return;
    }
    if (this.isCommenting || !this.post) return;
    
    this.isCommenting = true;
    try {
      // è¿™é‡Œéœ€è¦è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œæš‚æ—¶æ¨¡æ‹Ÿ
      const username = 'å½“å‰ç”¨æˆ·'; 
      const avatar = 'default_avatar';

      const response = await commentPost(this.postId, this.commentContent, username, avatar);
      if (response.code === 200) {
        promptAction.showToast({ message: 'è¯„è®ºæˆåŠŸ' });
        this.commentContent = '';
        // åˆ·æ–°è¯¦æƒ…æˆ–æ‰‹åŠ¨æ·»åŠ è¯„è®ºåˆ°åˆ—è¡¨
        this.loadPostDetail();
      } else {
        promptAction.showToast({ message: response.message || 'è¯„è®ºå¤±è´¥' });
      }
    } catch (error) {
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯' });
    } finally {
      this.isCommenting = false;
    }
  }

  async handleSetPrivate() {
    if (!this.post) return;
    try {
      const resp = await updatePostStatus(this.postId, 2);
      if (resp.code === 200) {
        promptAction.showToast({ message: 'å·²è®¾ä¸ºç§å¯†ï¼', duration: 1500 });
        if (this.post) this.post.status = 2;
      } else {
        promptAction.showToast({ message: resp.message || 'æ“ä½œå¤±è´¥' });
      }
    } catch (e) {
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯' });
    }
  }

  checkAndSetPrivate() {
    if (!this.post) return;
    if (this.post.status === 1) {
      AlertDialog.show({
        message: 'å®¡æ ¸ä¸­ï¼Œä¸èƒ½æ‰§è¡Œè¯¥æ“ä½œ',
        confirm: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      });
      return;
    }
    this.handleSetPrivate();
  }

  handleSetPublic() {
    AlertDialog.show({
      message: 'ç¡®å®šè¦å°†è¯¥å¸–å­å…¬å¼€å—ï¼Ÿ',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          this.confirmSetPublic();
        }
      }
    });
  }

  async confirmSetPublic() {
    if (!this.post) return;
    try {
      const resp = await updatePostStatus(this.postId, 0);
      if (resp.code === 200) {
        promptAction.showToast({ message: 'å·²è®¾ä¸ºå…¬å¼€ï¼', duration: 1500 });
        if (this.post) this.post.status = 0;
      } else {
        promptAction.showToast({ message: resp.message || 'æ“ä½œå¤±è´¥' });
      }
    } catch (e) {
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯' });
    }
  }

  handleDelete() {
    AlertDialog.show({
      title: 'ç¡®å®šåˆ é™¤ï¼Ÿ',
      message: 'è¯¥æ“ä½œä¸å¯æ’¤é”€',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'ç¡®å®š',
        action: () => {
          this.confirmDelete();
        }
      }
    });
  }

  async confirmDelete() {
    if (!this.post) return;
    try {
      const resp = await updatePostStatus(this.postId, 3);
      if (resp.code === 200) {
        promptAction.showToast({ message: 'å·²åˆ é™¤ï¼', duration: 1500 });
        if (this.post) this.post.status = 3;
        setTimeout(() => {
          try {
            // å°è¯•ä½¿ç”¨ UIContext çš„ router è¿”å›ï¼Œé¿å…ä¸Šä¸‹æ–‡ä¸¢å¤±é—®é¢˜
            this.getUIContext().getRouter().back();
          } catch (e) {
            RouterManager.goBack();
          }
        }, 1500);
      } else {
        promptAction.showToast({ message: resp.message || 'åˆ é™¤å¤±è´¥' });
      }
    } catch (e) {
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯' });
    }
  }

  navigateToComments() {
    if (!this.post) return;
    const params: PostCommentParams = { comments: this.post.comments };
    RouterManager.navigateTo('pages/forum/PostComment', params);
  }

  getMenuOptions(): MenuElementItem[] {
    const options: MenuElementItem[] = [];
    if (this.post && this.post.status === 2) {
      options.push({ value: 'è®¾ä¸ºå…¬å¼€', action: (): void => { this.handleSetPublic(); } });
    } else {
      options.push({ value: 'è®¾ä¸ºç§å¯†', action: (): void => { this.checkAndSetPrivate(); } });
    }
    options.push({ value: 'åˆ é™¤å¸–å­', action: (): void => { this.handleDelete(); } });
    return options;
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        // è¿”å›å›¾æ ‡
        Text('<')
          .fontSize(24)
          .fontColor('#333333')
          .margin({ right: 16 })
          .onClick(() => {
            RouterManager.goBack();
          })

        if (this.post) {
            Image(this.post.avatar || $r('app.media.layered_image')) // é»˜è®¤å¤´åƒ
            .width(32)
            .height(32)
            .borderRadius(16)
            .margin({ right: 8 })
            .backgroundColor('#E0E0E0')
            .onClick(() => {
              // è·³è½¬åˆ°ç”¨æˆ·ä¸»é¡µï¼Œä¼ é€’ userId/username/avatar
              const up: UserProfileParams = { userId: this.post!.userId, username: this.post!.username, avatar: this.post!.avatar };
              RouterManager.navigateTo('pages/forum/UserProfile', up);
            })

            Column() {
              Text(this.post.username)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .onClick(() => {
                  const up2: UserProfileParams = { userId: this.post!.userId, username: this.post!.username, avatar: this.post!.avatar };
                  RouterManager.navigateTo('pages/forum/UserProfile', up2);
                })
              
              if (this.post.status === 2) {
                Text('å½“å‰å¸–å­ä¸ºç§å¯†çŠ¶æ€')
                  .fontSize(10)
                  .fontColor('#FF9800')
                  .margin({ top: 2 })
              }
            }
            .alignItems(HorizontalAlign.Start)

            // ä½¿ç”¨ String() è½¬æ¢ç¡®ä¿ç±»å‹ä¸€è‡´ï¼Œé¿å…å› åç«¯è¿”å›ç±»å‹å·®å¼‚å¯¼è‡´æ¯”è¾ƒå¤±è´¥
            if (String(this.post.userId) === String(this.currentUserId)) {
              Blank()
              Text('...')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .padding({ left: 10, right: 10 })
                .bindMenu(this.getMenuOptions())
            }
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      .alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        LoadingProgress()
          .width(50)
          .height(50)
          .margin({ top: 100 })
      } else if (this.post) {
        Scroll() {
          Column() {
            // 2. å›¾ç‰‡è½®æ’­åŒºåŸŸ
            if (this.post.images && this.post.images.length > 0) {
              Swiper() {
                ForEach(this.post.images, (image: string) => {
                  Image(image)
                    .width('100%')
                    .height(300)
                    .objectFit(ImageFit.Cover)
                    .backgroundColor('#F5F5F5')
                })
              }
              .width('100%')
              .height(300)
              .indicator(true)
              .loop(false)
            }

            // 3. æ ‡é¢˜å’Œå†…å®¹
            Column() {
              Text(this.post.title)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .margin({ bottom: 12 })
                .width('100%')

              Text(this.post.content)
                .fontSize(16)
                .fontColor('#666666')
                .lineHeight(24)
                .width('100%')
            }
            .padding(16)
            .width('100%')
            .alignItems(HorizontalAlign.Start)
          }
        }
        .layoutWeight(1)
        .width('100%')

        // 4. åº•éƒ¨è¯„è®ºè¾“å…¥æ¡†å’Œæ“ä½œæ 
        Column() {
          // è¯„è®ºè¾“å…¥æ¡†
          Row() {
            TextInput({ placeholder: 'è¾“å…¥è¯„è®º...', text: this.commentContent })
              .layoutWeight(1)
              .height(40)
              .backgroundColor('#F5F5F5')
              .borderRadius(20)
              .padding({ left: 16, right: 16 })
              .onChange((value: string) => {
                this.commentContent = value;
              })

            Button('å‘é€')
              .height(32)
              .fontSize(14)
              .fontColor('#FFFFFF')
              .backgroundColor('#007AFF')
              .borderRadius(16)
              .margin({ left: 12 })
              .onClick(() => {
                this.handleComment();
              })
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor('#FFFFFF')
          .border({ width: { bottom: 1 }, color: '#F0F0F0' })

          // 5. åº•éƒ¨çŠ¶æ€æ ï¼ˆç‚¹èµæ•°ã€è¯„è®ºæ•°ï¼‰
          Row() {
            Blank()

            Row() {
              // ç‚¹èµ
              Row() {
                Text('â¤') // æ›¿æ¢ä¸ºç‚¹èµå›¾æ ‡
                  .fontSize(20)
                  .fontColor('#FF4444')
                  .margin({ right: 4 })
                Text(this.post.likeCount.toString())
                  .fontSize(14)
                  .fontColor('#666666')
              }
              .onClick(() => {
                this.handleLike();
              })
              .margin({ right: 24 })

              // è¯„è®ºï¼ˆç‚¹å‡»è·³è½¬ï¼‰
              Row() {
                Text('ğŸ’¬') // æ›¿æ¢ä¸ºè¯„è®ºå›¾æ ‡
                  .fontSize(20)
                  .fontColor('#666666')
                  .margin({ right: 4 })
                Text(this.post.comments ? this.post.comments.length.toString() : '0')
                  .fontSize(14)
                  .fontColor('#666666')
              }
              .onClick(() => {
                this.navigateToComments();
              })
            }
          }
          .width('100%')
          .height(40)
          .padding({ right: 16 })
          .backgroundColor('#FFFFFF')
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
  }
}
