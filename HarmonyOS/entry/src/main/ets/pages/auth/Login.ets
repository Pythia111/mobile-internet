import router from '@ohos.router';
import RouterManager, { Routes } from '../../router/RouterManager';
import { login } from '../../model/api/AuthApi';
import TokenManager from '../../utils/TokenManager';
import promptAction from '@ohos.promptAction';
import NetworkTest from '../../utils/NetworkTest';
import { ApiConfig } from '../../config/ApiConfig';

@Entry
@Component
struct Login {
  @State phone: string = '';
  @State password: string = '';
  @State isLoading: boolean = false;
  @State phoneError: string = '';
  @State passwordError: string = '';
  @State debugMode: boolean = false; // è°ƒè¯•æ¨¡å¼

  // éªŒè¯æ‰‹æœºå·
  validatePhone(phone: string): string {
    if (!phone) {
      return 'è¯·è¾“å…¥æ‰‹æœºå·';
    }
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(phone)) {
      return 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·';
    }
    return '';
  }

  // éªŒè¯å¯†ç 
  validatePassword(password: string): string {
    if (!password) {
      return 'è¯·è¾“å…¥å¯†ç ';
    }
    if (password.length < 6) {
      return 'å¯†ç è‡³å°‘6ä½';
    }
    const hasLetter = /[a-zA-Z]/.test(password);
    const hasNumber = /\d/.test(password);
    if (!hasLetter || !hasNumber) {
      return 'å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—';
    }
    return '';
  }

  // åˆ‡æ¢æœåŠ¡å™¨åœ°å€
  switchServerAddress() {
    const newAddress = ApiConfig.switchToNextAddress();
    promptAction.showToast({
      message: `åˆ‡æ¢æœåŠ¡å™¨åœ°å€: ${newAddress}`,
      duration: 3000
    });
  }

  // æµ‹è¯•ç½‘ç»œè¿æ¥
  async testNetwork() {
    console.info('Login: å¼€å§‹æµ‹è¯•ç½‘ç»œè¿æ¥');
    
    // æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„APIåœ°å€
    promptAction.showToast({
      message: 'æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿æ¥...',
      duration: 1000
    });
    
    try {
      // å…ˆæµ‹è¯•åŸºæœ¬ç½‘ç»œè¿æ¥
      const isConnected = await NetworkTest.testConnection();
      if (isConnected) {
        promptAction.showToast({
          message: 'ç½‘ç»œè¿æ¥æ­£å¸¸',
          duration: 2000
        });
      } else {
        promptAction.showToast({
          message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡',
          duration: 3000
        });
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      console.error('Login: ç½‘ç»œæµ‹è¯•é”™è¯¯', errorMessage);
      promptAction.showToast({
        message: `ç½‘ç»œæµ‹è¯•å¤±è´¥: ${errorMessage}`,
        duration: 3000
      });
    }
  }

  // ç™»å½•å¤„ç†
  async handleLogin() {
    console.info('Login: å¼€å§‹ç™»å½•æµç¨‹');
    console.info(`Login: æ‰‹æœºå·=${this.phone}`);
    
    // è°ƒè¯•æ¨¡å¼ï¼šè·³è¿‡ç½‘ç»œè¯·æ±‚ç›´æ¥è·³è½¬
    if (this.debugMode) {
      console.info('Login: è°ƒè¯•æ¨¡å¼ï¼Œè·³è¿‡ç½‘ç»œè¯·æ±‚');
      promptAction.showToast({
        message: 'è°ƒè¯•æ¨¡å¼ï¼šç›´æ¥è·³è½¬',
        duration: 2000
      });
      
      setTimeout(async () => {
        try {
          const ok = await RouterManager.safeReplaceTo(Routes.INDEX);
          if (ok) {
            console.info('Login: è°ƒè¯•æ¨¡å¼è·³è½¬æˆåŠŸ');
          } else {
            console.warn('Login: è°ƒè¯•æ¨¡å¼è·³è½¬æœªæˆåŠŸ');
          }
        } catch (err) {
          console.error('Login: è°ƒè¯•æ¨¡å¼è·³è½¬å¤±è´¥', JSON.stringify(err));
        }
      }, 1000);
      return;
    }
    
    // éªŒè¯è¾“å…¥
    this.phoneError = this.validatePhone(this.phone);
    this.passwordError = this.validatePassword(this.password);

    if (this.phoneError || this.passwordError) {
      console.warn('Login: è¡¨å•éªŒè¯å¤±è´¥');
      return;
    }

    this.isLoading = true;
    console.info('Login: å¼€å§‹å‘èµ·ç™»å½•è¯·æ±‚');

    try {
      console.info('Login: è°ƒç”¨ login API');
      const response = await login(this.phone, this.password);
      try { console.info('Login: æ”¶åˆ°å“åº”', JSON.stringify(response)); } catch(e) { console.info('Login: æ”¶åˆ°å“åº” (éåºåˆ—åŒ–)'); }
      
      if (response.code === 200) {
        // ä¿å­˜token
        try {
          await TokenManager.setToken(response.data.token);
          console.info('Login: Tokenå·²ä¿å­˜ï¼Œå‡†å¤‡è·³è½¬');
        } catch (tokErr) {
          try { console.error('Login: Token ä¿å­˜å¼‚å¸¸', JSON.stringify(tokErr)); } catch(e) { console.error('Login: Token ä¿å­˜å¼‚å¸¸', tokErr); }
          // ArkTS é™åˆ¶ throw çš„ç±»å‹ï¼Œç¡®ä¿æŠ›å‡º Error
          throw new Error(typeof tokErr === 'string' ? tokErr : (tokErr && tokErr.message) ? tokErr.message : 'Token ä¿å­˜å¼‚å¸¸');
        }
        
        // å…ˆå®‰æ’å¯¼èˆªä»»åŠ¡ï¼Œä¿è¯å³ä½¿ showToast æŠ›å¼‚å¸¸ä¹Ÿèƒ½æ‰§è¡Œå¯¼èˆª
        const doNavigate = async () => {
          console.info('Login: å¼€å§‹è·³è½¬åˆ°ä¸»é¡µ');
          console.info('Login: RouterManager ç±»å‹æ£€æŸ¥', typeof RouterManager);
          console.info('Login: Routes.INDEX å€¼', Routes.INDEX);
          try {
            const ok = await RouterManager.safeReplaceTo(Routes.INDEX);
            if (ok) {
              console.info('Login: æˆåŠŸè·³è½¬åˆ°ä¸»é¡µ');
            } else {
              console.warn('Login: è·³è½¬æœªæˆåŠŸï¼Œä½†å·²å°è¯•é™çº§å¤„ç†');
            }
          } catch (navErr) {
            try { console.error('Login: è·³è½¬å¼‚å¸¸', JSON.stringify(navErr)); } catch(e) { console.error('Login: è·³è½¬å¼‚å¸¸', navErr); }
            // é™çº§æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨ router.pushUrl
            try {
              await router.pushUrl({ url: 'pages/Index' });
              console.info('Login: é™çº§è·³è½¬æˆåŠŸ');
            } catch (fallbackErr) {
              try { console.error('Login: é™çº§è·³è½¬ä¹Ÿå¤±è´¥', JSON.stringify(fallbackErr)); } catch(e) { console.error('Login: é™çº§è·³è½¬ä¹Ÿå¤±è´¥', fallbackErr); }
            }
          }
        };

        setTimeout(doNavigate, 500);

        try {
          promptAction.showToast({
            message: 'ç™»å½•æˆåŠŸ',
            duration: 2000
          });
        } catch (toastErr) {
          try { console.warn('Login: showToast failed', JSON.stringify(toastErr)); } catch(e) { console.warn('Login: showToast failed', toastErr); }
        }
      } else {
        console.warn('Login: ç™»å½•å¤±è´¥', response.message);
        promptAction.showToast({
          message: response.message || 'ç™»å½•å¤±è´¥',
          duration: 2000
        });
      }
    } catch (error) {
      try { console.error('Login: ç™»å½•é”™è¯¯', JSON.stringify(error)); } catch(e) { console.error('Login: ç™»å½•é”™è¯¯', error); }
      let msg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
      try {
        if (error && typeof error === 'object') {
          if (error.message) msg = error.message;
          else if (error.code) msg = `é”™è¯¯ä»£ç : ${error.code}`;
        } else if (typeof error === 'string') {
          msg = error;
        }
      } catch (e) {}
      promptAction.showToast({
        message: msg,
        duration: 3000
      });
    } finally {
      this.isLoading = false;
      console.info('Login: ç™»å½•æµç¨‹ç»“æŸ');
    }
  }

  // è·³è½¬åˆ°æ³¨å†Œé¡µé¢
  goToRegister() {
    RouterManager.goToRegister();
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('é¥®é£Ÿè®°å½•')
        .fontSize(36)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2E7D32') // Dark Green
        .margin({ top: 80, bottom: 40 })
        .letterSpacing(2)

      // ç™»å½•è¡¨å•
      Column() {
        // æ‰‹æœºå·è¾“å…¥æ¡†
        Column() {
          TextInput({ placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·', text: this.phone })
            .height(50)
            .fontSize(16)
            .fontColor('#333333')
            .backgroundColor('#FAFAFA')
            .border({
              width: 1,
              color: this.phoneError ? '#FF4444' : '#E0E0E0',
              radius: 8
            })
            .placeholderColor('#999999')
            .onChange((value: string) => {
              this.phone = value;
              if (this.phoneError) {
                this.phoneError = this.validatePhone(value);
              }
            })
            .onFocus(() => {
              this.phoneError = '';
            })

          if (this.phoneError) {
            Text(this.phoneError)
              .fontSize(12)
              .fontColor('#FF4444')
              .alignSelf(ItemAlign.Start)
              .margin({ top: 5, left: 5 })
          }
        }
        .width('100%')
        .margin({ bottom: 20 })

        // å¯†ç è¾“å…¥æ¡†
        Column() {
          TextInput({ placeholder: 'è¯·è¾“å…¥å¯†ç ', text: this.password })
            .type(InputType.Password)
            .height(50)
            .fontSize(16)
            .fontColor('#333333')
            .backgroundColor('#FAFAFA')
            .border({
              width: 1,
              color: this.passwordError ? '#FF4444' : '#E0E0E0',
              radius: 8
            })
            .placeholderColor('#999999')
            .onChange((value: string) => {
              this.password = value;
              if (this.passwordError) {
                this.passwordError = this.validatePassword(value);
              }
            })
            .onFocus(() => {
              this.passwordError = '';
            })

          if (this.passwordError) {
            Text(this.passwordError)
              .fontSize(12)
              .fontColor('#FF4444')
              .alignSelf(ItemAlign.Start)
              .margin({ top: 5, left: 5 })
          }
        }
        .width('100%')
        .margin({ bottom: 20 })

        // æ³¨å†Œå¼•å¯¼
        Row() {
          Text('æ²¡æœ‰è´¦å·ï¼Ÿ')
            .fontSize(14)
            .fontColor('#666666')
          
          Button('ç«‹å³æ³¨å†Œ')
            .type(ButtonType.Normal)
            .fontSize(14)
            .fontColor('#4CAF50')
            .backgroundColor('transparent')
            .border({ width: 1, color: '#4CAF50', radius: 4 })
            .height(30)
            .width(160)
            .margin({ left: 10 })
            .onClick(() => {
              this.goToRegister();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Start)
        .alignItems(VerticalAlign.Center)
        .margin({ bottom: 40 })

        // ç™»å½•æŒ‰é’®
        Button(this.isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•')
          .width('100%')
          .height(50)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .backgroundColor(this.isLoading ? '#A5D6A7' : '#4CAF50') // Green theme
          .border({ radius: 25 })
          .shadow({ radius: 5, color: '#4CAF5040', offsetY: 5 })
          .enabled(!this.isLoading)
          .onClick(() => {
            console.info('Login: ç™»å½•æŒ‰é’®è¢«ç‚¹å‡»');
            promptAction.showToast({
              message: 'å¼€å§‹ç™»å½•...',
              duration: 1000
            });
            this.handleLogin();
          })
        
        // æœåŠ¡å™¨é€‰æ‹©æŒ‰é’®
        Button('ğŸŒ é€‰æ‹©æœåŠ¡å™¨')
          .width('100%')
          .height(45)
          .fontSize(14)
          .fontColor('#FFFFFF')
          .backgroundColor('#2196F3')
          .border({ radius: 20 })
          .margin({ top: 15 })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/dev/ServerSelector'
            });
          })
        
        // æµ‹è¯•ç½‘ç»œè¿æ¥æŒ‰é’®
        Button('æµ‹è¯•ç½‘ç»œè¿æ¥')
          .width('100%')
          .height(40)
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#F5F5F5')
          .border({ width: 1, color: '#E0E0E0', radius: 20 })
          .margin({ top: 10 })
          .onClick(() => {
            console.info('Login: æµ‹è¯•ç½‘ç»œæŒ‰é’®è¢«ç‚¹å‡»');
            this.testNetwork();
          })
          
        // åˆ‡æ¢æœåŠ¡å™¨åœ°å€æŒ‰é’®
        Button('åˆ‡æ¢æœåŠ¡å™¨åœ°å€')
          .width('100%')
          .height(40)
          .fontSize(14)
          .fontColor('#666666')
          .backgroundColor('#F0F8FF')
          .border({ width: 1, color: '#87CEEB', radius: 20 })
          .margin({ top: 10 })
          .onClick(() => {
            this.switchServerAddress();
          })
          
        // è°ƒè¯•æ¨¡å¼å¼€å…³
        Row() {
          Text('è°ƒè¯•æ¨¡å¼:')
            .fontSize(14)
            .fontColor('#666666')
          Toggle({ type: ToggleType.Switch, isOn: this.debugMode })
            .selectedColor('#4CAF50')
            .margin({ left: 10 })
            .onChange((isOn: boolean) => {
              this.debugMode = isOn;
              promptAction.showToast({
                message: `è°ƒè¯•æ¨¡å¼: ${isOn ? 'å¼€å¯' : 'å…³é—­'}`,
                duration: 2000
              });
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ top: 10 })
          
        // æ˜¾ç¤ºAPIåœ°å€ä¿¡æ¯
        Text(`APIåœ°å€: ${ApiConfig.getCurrentBaseUrl()}`)
          .fontSize(12)
          .fontColor('#999999')
          .margin({ top: 10 })
          .textAlign(TextAlign.Center)
      }
      .width('85%')
      .padding({ top: 40, bottom: 40, left: 25, right: 25 })
      .backgroundColor('#FFFFFF')
      .border({ radius: 16, width: 1, color: '#EEEEEE' })
      .shadow({
        radius: 20,
        color: '#0000000A',
        offsetX: 0,
        offsetY: 10
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F9F9F9')
    .justifyContent(FlexAlign.Start)
    .padding({ top: 20 })
  }
}