// pages/diet/DietHistory.ets
import DietApi, { DailyRecord, MealRecord, MealFood } from '../../model/api/diet/DietApi';
import { CustomCard } from '../../components/CustomCard';

@Component
export struct DietHistory {
  @State dietHistory: DailyRecord[] = [];
  @State isLoading: boolean = true;
  @Consume('refreshTrigger') @Watch('onRefresh') refreshTrigger: number;

  aboutToAppear() {
    console.log('DietHistory: aboutToAppear');
    this.loadDietHistory();
  }

  onRefresh() {
    console.log('DietHistory: onRefresh - Ê£ÄÊµãÂà∞TabÂàáÊç¢ÔºåÂà∑Êñ∞Êï∞ÊçÆ');
    this.loadDietHistory();
  }

  async loadDietHistory() {
    this.isLoading = true;
    try {
      const history: DailyRecord[] = await DietApi.getDietHistory();
      this.dietHistory = history;
    } catch (error) {
      console.error('Âä†ËΩΩÈ•ÆÈ£üÂéÜÂè≤Â§±Ë¥•:', error);
      this.dietHistory = [];
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      Text('È•ÆÈ£üÂéÜÂè≤ËÆ∞ÂΩï')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin(20)

      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('Âä†ËΩΩ‰∏≠...')
            .fontSize(14)
            .margin({ top: 10 })
            .fontColor('#666')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.dietHistory.length === 0) {
        Column() {
          Text('ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï')
            .fontSize(16)
            .fontColor('#999')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        List() {
          ForEach(this.dietHistory, (dayRecord: DailyRecord) => {
            ListItem() {
              Column() {
                // Êó•ÊúüÊ†áÈ¢ò
                Row() {
                  Text(dayRecord.date)
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                  Blank()
                  Text(this.calculateDayCalories(dayRecord) + ' kcal')
                    .fontSize(14)
                    .fontColor(Color.Gray)
                }
                .width('100%')
                .margin({ bottom: 12 })

                // ÂêÑÈ§êÊ¨°ËÆ∞ÂΩï
                ForEach(dayRecord.meals, (meal: MealRecord) => {
                  if (meal.foods.length > 0) {
                    this.MealCard(meal)
                  }
                })
              }
              .padding(16)
            }
          })
        }
        .width('100%')
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder MealCard(meal: MealRecord) {
    CustomCard() {
      Column() {
        // È§êÊ¨°Ê†áÈ¢ò
        Row() {
          Text(this.getMealTypeText(meal.mealType))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
          Blank()
          Text(this.calculateMealCalories(meal) + ' kcal')
            .fontSize(14)
            .fontColor(Color.Gray)
        }
        .width('100%')

        // È£üÁâ©ÂàóË°®
        ForEach(meal.foods, (food: MealFood) => {
          Row() {
            Column() {
              Text('üçΩÔ∏è')
                .fontSize(24)
            }
            .width(40)
            .height(40)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('#E0E0E0')
            .borderRadius(8)
            .margin({ right: 12 })

            Column() {
              Text(`${food.foodName}${food.weight ? `Ôºà${food.weight}gÔºâ` : ''}`)
                .fontSize(14)
                .fontWeight(FontWeight.Medium)
              Text(`ÁÉ≠Èáè: ${food.calories}kcal | ËõãÁôΩË¥®: ${food.protein ?? '-'}g | Á¢≥Ê∞¥: ${food.carbohydrates ?? '-'}g | ËÑÇËÇ™: ${food.fat ?? '-'}g`)
                .fontSize(12)
                .fontColor(Color.Gray)
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
          }
          .width('100%')
          .padding({ top: 8, bottom: 8 })
        })
      }
      .padding(12)
    }
  }

  getMealTypeText(mealType: string): string {
    const mealMap: Record<string, string> = {
      'breakfast': 'Êó©È§ê',
      'lunch': 'ÂçàÈ§ê',
      'dinner': 'ÊôöÈ§ê',
      'snack': 'Âä†È§ê'
    };
    return mealMap[mealType] || mealType;
  }

  calculateDayCalories(dayRecord: DailyRecord): number {
    return dayRecord.meals.reduce((total: number, meal: MealRecord) => {
      return total + this.calculateMealCalories(meal);
    }, 0);
  }

  calculateMealCalories(meal: MealRecord): number {
    return meal.foods.reduce((total: number, food: MealFood) => total + food.calories, 0);
  }
}
