// pages/diet/DietSearch.ets
import DietApi, { FoodItem, FoodRecord } from '../../model/api/diet/DietApi';
import hilog from '@ohos.hilog';

const TAG = 'DietSearch';
const DOMAIN = 0x0001;

@Entry
@Component
export struct DietSearch {
  @State searchKeyword: string = '';
  @State searchResults: FoodItem[] = [];
  // è®°å½•æ¯ä¸ªé£Ÿç‰©çš„é‡é‡ï¼ˆgï¼‰ï¼Œkeyä¸ºfoodNameï¼Œvalueä¸ºnumber
  @State foodWeights: Record<string, number> = {};
  @State selectedMealType: string = 'breakfast';
  @State isLoading: boolean = false;
  @State hasSearched: boolean = false;

  // ToastçŠ¶æ€ç®¡ç†
  @State toastMessage: string = '';
  @State showToast: boolean = false;
  @State toastType: 'success' | 'error' = 'success';

  aboutToAppear() {
    hilog.info(DOMAIN, TAG, 'ğŸ‰ DietSearché¡µé¢åŠ è½½å®Œæˆ');
  }

  // è‡ªå®šä¹‰Toastæ˜¾ç¤ºæ–¹æ³•
  showCustomToast(message: string, type: 'success' | 'error' = 'success') {
    this.toastMessage = message;
    this.toastType = type;
    this.showToast = true;

    // 2ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
      this.showToast = false;
    }, 2000);
  }

  async searchFood() {
    if (this.searchKeyword.trim() === '') {
      this.showCustomToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'error');
      this.searchResults = [];
      this.hasSearched = false;
      return;
    }

    this.isLoading = true;
    this.hasSearched = true;

    try {
      hilog.info(DOMAIN, TAG, 'å¼€å§‹æœç´¢é£Ÿç‰©: %{public}s', this.searchKeyword);
      const results: FoodItem[] = await DietApi.searchFood(this.searchKeyword);
      hilog.info(DOMAIN, TAG, 'æœç´¢å®Œæˆï¼Œç»“æœæ•°é‡: %{public}d', results.length);

      this.searchResults = results;

      if (results.length === 0) {
        this.showCustomToast('æœªæ‰¾åˆ°ç›¸å…³é£Ÿç‰©', 'error');
      }
    } catch (error) {
      let errorMsg = 'æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
      this.showCustomToast(errorMsg, 'error');
      this.searchResults = [];
    } finally {
      this.isLoading = false;
    }
  }

  async addFoodRecord(food: FoodItem) {
    hilog.info(DOMAIN, TAG, 'æ·»åŠ é£Ÿç‰©è®°å½•: %{public}s', food.foodName);
    // è·å–ç”¨æˆ·è¾“å…¥çš„é‡é‡ï¼Œé»˜è®¤ä¸º100g
    const weight = this.foodWeights[food.foodName] ?? 100;
    try {
      // è®¡ç®—æ€»è¥å…»å€¼
      const ratio = weight / 100;
      const record: FoodRecord = {
        foodName: food.foodName,
        calories: Math.round(food.calories * ratio * 10) / 10,
        protein: Math.round(food.protein * ratio * 10) / 10,
        carbohydrates: Math.round(food.carbohydrates * ratio * 10) / 10,
        fat: Math.round(food.fat * ratio * 10) / 10,
        mealType: this.selectedMealType as 'breakfast' | 'lunch' | 'dinner' | 'snack',
        date: this.getFormattedDate(new Date()),
        // å¯æ‰©å±•: weight: weight
      };
      hilog.debug(DOMAIN, TAG, 'å‘é€è®°å½•æ•°æ®: %{public}s', JSON.stringify(record));
      const result = await DietApi.addDietRecord(record);
      this.showCustomToast(`âœ“ å·²æ·»åŠ  ${food.foodName}ï¼ˆ${weight}gï¼‰ï¼Œç‚¹å‡»\"é¥®é£Ÿè®°å½•\"æŸ¥çœ‹`, 'success');
      hilog.info(DOMAIN, TAG, 'æ·»åŠ è®°å½•æˆåŠŸï¼ŒrecordId: %{public}s', result.recordId);
    } catch (error) {
      let errorMsg = 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•';
      this.showCustomToast(errorMsg, 'error');
      hilog.error(DOMAIN, TAG, 'æ·»åŠ è®°å½•å¤±è´¥: %{public}s', errorMsg);
    }
  }

  getFormattedDate(date: Date): string {
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  build() {
    Column() {
      // é¡µé¢æ ‡é¢˜
      Text('æœç´¢é£Ÿç‰©')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 20 })

      this.SearchTab()

      // è‡ªå®šä¹‰Toastæ˜¾ç¤º
      if (this.showToast) {
        this.CustomToastBuilder()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  @Builder CustomToastBuilder() {
    Column() {
      Text(this.toastMessage)
        .fontSize(16)
        .fontColor(Color.White)
        .padding({ left: 24, right: 24, top: 12, bottom: 12 })
        .backgroundColor(this.toastType === 'success' ? '#4CAF50' : '#FF9800')
        .borderRadius(25)
        .shadow({ radius: 8, color: '#40000000', offsetX: 0, offsetY: 4 })
    }
    .width('100%')
    .position({ x: 0, y: '80%' })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder SearchTab() {
    Column() {
      // æœç´¢è¡Œ
      Row() {
        TextInput({ placeholder: 'æœç´¢é£Ÿç‰©...', text: this.searchKeyword })
          .layoutWeight(1)
          .height(40)
          .type(InputType.Normal)
          .enterKeyType(EnterKeyType.Search)
          .onChange((value: string) => {
            this.searchKeyword = value;
          })
          .onSubmit(() => {
            this.searchFood();
          })

        Button('æœç´¢')
          .width(60)
          .height(40)
          .margin({ left: 10 })
          .backgroundColor('#4CAF50')
          .fontColor(Color.White)
          .onClick(() => {
            this.searchFood();
          })
      }
      .width('90%')
      .margin(10)

      // é¤åˆ«é€‰æ‹©
      Row() {
        Text('é€‰æ‹©é¤åˆ«:')
          .fontSize(16)
          .margin({ right: 10 })

        Radio({ value: 'breakfast', group: 'mealType' })
          .checked(this.selectedMealType === 'breakfast')
          .onChange((value: boolean) => {
            if (value) this.selectedMealType = 'breakfast';
          })
        Text('æ—©é¤')
          .fontSize(14)
          .margin({ right: 10 })

        Radio({ value: 'lunch', group: 'mealType' })
          .checked(this.selectedMealType === 'lunch')
          .onChange((value: boolean) => {
            if (value) this.selectedMealType = 'lunch';
          })
        Text('åˆé¤')
          .fontSize(14)
          .margin({ right: 10 })

        Radio({ value: 'dinner', group: 'mealType' })
          .checked(this.selectedMealType === 'dinner')
          .onChange((value: boolean) => {
            if (value) this.selectedMealType = 'dinner';
          })
        Text('æ™šé¤')
          .fontSize(14)
          .margin({ right: 10 })

        Radio({ value: 'snack', group: 'mealType' })
          .checked(this.selectedMealType === 'snack')
          .onChange((value: boolean) => {
            if (value) this.selectedMealType = 'snack';
          })
        Text('åŠ é¤')
          .fontSize(14)
      }
      .width('90%')
      .margin(10)

      // æœç´¢ç»“æœåŒºåŸŸ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('æœç´¢ä¸­...')
            .fontSize(14)
            .margin({ top: 10 })
            .fontColor('#666')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.hasSearched && this.searchResults.length === 0) {
        Column() {
          Text('æœªæ‰¾åˆ°ç›¸å…³é£Ÿç‰©')
            .fontSize(16)
            .fontColor('#999')
            .margin({ top: 10 })
          Text('è¯·å°è¯•å…¶ä»–å…³é”®è¯')
            .fontSize(14)
            .fontColor('#666')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else if (this.searchResults.length > 0) {
        Text(`æ‰¾åˆ° ${this.searchResults.length} ä¸ªç»“æœ`)
          .fontSize(14)
          .fontColor('#666')
          .width('90%')
          .textAlign(TextAlign.Start)
          .margin({ bottom: 10 })

        List() {
          ForEach(this.searchResults, (food: FoodItem) => {
            ListItem() {
              this.FoodItemBuilder(food)
            }
          }, (food: FoodItem) => food.foodName)
        }
        .layoutWeight(1)
        .width('100%')
      } else {
        Column() {
          Text('è¯·è¾“å…¥é£Ÿç‰©åç§°æœç´¢')
            .fontSize(16)
            .fontColor('#999')
          Text('ä¾‹å¦‚ï¼šè‹¹æœã€ç±³é¥­ã€é¸¡èƒ¸è‚‰ç­‰')
            .fontSize(14)
            .fontColor('#666')
            .margin({ top: 5 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder FoodItemBuilder(food: FoodItem) {
    Row() {
      Column() {
        Text(food.foodName)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .textAlign(TextAlign.Start)
        Text(`çƒ­é‡: ${food.calories}kcal | è›‹ç™½è´¨: ${food.protein}g | ç¢³æ°´: ${food.carbohydrates}g | è„‚è‚ª: ${food.fat}g`)
          .fontSize(12)
          .fontColor(Color.Gray)
          .textAlign(TextAlign.Start)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // æ–°å¢é‡é‡è¾“å…¥æ¡†
      Column() {
        Text('é‡é‡(g)')
          .fontSize(12)
          .fontColor(Color.Gray)
        TextInput({ placeholder: '100', text: (this.foodWeights[food.foodName]?.toString() ?? '100') })
          .type(InputType.Number)
          .width(60)
          .height(30)
          .fontSize(12)
          .onChange((value: string) => {
            let num = parseInt(value);
            if (isNaN(num) || num <= 0) num = 100;
            this.foodWeights[food.foodName] = num;
          })
      }
      .alignItems(HorizontalAlign.Center)
      .margin({ right: 8 })

      Button('æ·»åŠ ')
        .fontSize(12)
        .width(60)
        .height(30)
        .backgroundColor('#4CAF50')
        .fontColor(Color.White)
        .onClick(() => {
          this.addFoodRecord(food);
        })
    }
    .width('100%')
    .padding(10)
    .border({ width: 1, color: '#E0E0E0' })
    .margin({ bottom: 5 })
    .borderRadius(8)
  }
}
