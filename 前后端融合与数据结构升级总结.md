# 项目前后端融合与后端数据结构升级问题总结

## 一、主要目标
- 实现饮食AI搜索、记录、历史等功能的前后端完整闭环。
- 支持用户自定义食物重量，所有营养数据（热量、蛋白质、碳水、脂肪）均按实际重量计算并展示。
- 前端、后端、数据库三端数据结构保持一致，支持营养字段的精确存储与展示。

## 二、前后端融合关键点
1. **前端改造**
   - 搜索结果页每个食物项新增“重量(g)”输入框，用户可填写实际食用克数。
   - 添加饮食记录时，将食物的重量、热量、蛋白质、碳水、脂肪等字段一并传递给后端。
   - 饮食记录页、历史记录页展示每条食物的“总热量/蛋白质/碳水/脂肪”，并显示重量。
   - 今日总览、各项营养总和均为所有食物实际总和，且只保留一位小数。

2. **后端接口与DTO升级**
   - `DietRecordDetailDto` 新增 `protein`、`carbohydrates`、`fat`、`weight` 字段，构造方法同步补全。
   - `DietService.getDietHistory` 返回历史记录时，所有营养字段和重量字段一并封装进DTO，保证前端能完整获取。
   - 添加饮食记录时，后端同步保存所有营养字段和重量字段。

3. **数据库结构升级**
   - `DietRecord` 实体类新增 `weight` 字段（BigDecimal），并自动生成 getter/setter。
   - H2数据库表 `diet_records` 新增 `weight` 字段（`ALTER TABLE diet_records ADD COLUMN weight DECIMAL(10,2);`）。
   - Spring Boot 配置 `spring.jpa.hibernate.ddl-auto=update`，重启服务后表结构自动同步。

## 三、常见问题与解决方案
- **前端蛋白质、碳水、脂肪显示为“-g”**
  - 原因：后端未返回这些字段，或DTO/实体/数据库未同步升级。
  - 解决：后端DTO、实体、数据库三端字段全部补全，前端MealFood类型同步。

- **weight字段未定义/数据库插入报错**
  - 原因：实体类有weight但表结构未升级。
  - 解决：H2控制台或自动建表机制同步添加weight字段。

- **今日总览营养值为推算而非真实总和**
  - 原因：前端用比例公式推算。
  - 解决：前端直接累加所有食物的真实营养字段。

## 四、最佳实践总结
- 前后端、数据库三端字段保持一致，接口返回结构与前端数据模型严格对齐。
- 新增字段优先用可选类型，兼容老数据。
- 数据库结构升级优先用自动建表，必要时手动ALTER同步。
- 前端展示数值时统一格式（如保留一位小数），提升用户体验。

---

如需详细代码示例或迁移脚本，可参考本次聊天历史或联系开发支持。